#!/usr/bin/env node
const fs = require('fs')
const { resolve } = require('path')
const path = require('path')
const cwd = process.cwd()
const rl = require('readline').createInterface({
  input: process.stdin,
  output: process.stdout
})

const samplePath = path.resolve(__dirname, '../sample')
const target = path.resolve(cwd, 'dist')
if (fs.existsSync(target)) {
  fs.rmdirSync(target, {
    recursive: true
  })
}
fs.mkdirSync(target)

function inputTitle () {
  return new Promise((resolve, reject) => {
    rl.question('请输入你的网站标题：', title => {
      resolve(title)
    })
  })
}

function  createHtml (title) {
  return new Promise((resolve, reject) => {
    var file = filePath = samplePath + '/index.html'
    fs.readFile(file, 'utf8', (err, data) => {
      if (err) return fatal(err)
      fs.open(target + '/index.html', 'w', (err, fd) => {
        if (err) return fatal(err)
        fs.write(fd, data.replace(/\{\{title\}\}/g, title), (err) => {
          if (err) return fatal(err)
          fs.close(fd, err => {
            if (err) return fatal(err)
            resolve(true)
          })        
        })
      })
    })
  })
}

function copySrc () {
  return new Promise ((resolve, reject) => {
    const src = path.resolve(target, 'src')
    fs.mkdirSync(src)
    fs.readdir(samplePath + '/src', (err, files) => {
      if (err) fatal(err)
      files.forEach(file => {
        let filePath = samplePath + '/src/'+ file
        let stats = fs.statSync(filePath)
        stats.isFile() && fs.copyFileSync(filePath, src + '/' +file)
        stats.isDirectory() && fs.mkdirSync(target + '/' + file)
      })
      resolve()
    })
  })
}

function createConfigs(title) {
  return new Promise((resolve, reject) => {
    let now = Date.now()
    fs.open(target + '/configs.js', 'w', (err, fd) => {
      if (err) return reject(err)
      fs.write(fd, 
`export default {
  title: "${title}",
  name: "test",
  level: 7,
  time: ${now}
}
`, (err) => {
        if (err) return fatal(err)
        fs.close(fd, err => {
          if (err) return fatal(err)
          resolve(true)
        })
      })
    })
  })
}

async function run () {
  // let title = await inputTitle().catch(err => {
  //   console.log('input title:', err)
  //   process.exit()
  // })
  // console.log('title:', title)
  // if (!title) return
  let title = 'webgen test'
  Promise.all([
    createHtml(title),
    createConfigs(title),
    copySrc()
  ]).then(() => {
    process.exit()
  })
}

function fatal (err) {
  console.error(err)
  process.exit()
}

run()
