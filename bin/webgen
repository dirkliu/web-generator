#!/usr/bin/env node
const fs = require('fs')
const { resolve } = require('path')
const path = require('path')
const cwd = process.cwd()
const rl = require('readline').createInterface({
  input: process.stdin,
  output: process.stdout
})

const samplePath = path.resolve(__dirname, '../sample')
const target = path.resolve(cwd, 'dist')
if (fs.existsSync(target)) {
  fs.rmdirSync(target, {
    recursive: true
  })
}
fs.mkdirSync(target)

function inputTitle () {
  return new Promise((resolve, reject) => {
    rl.question('请输入你的网站标题：', title => {
      resolve(title)
    })
  })
}

function  createHtml (title) {
  return new Promise((resolve, reject) => {
    var file = filePath = samplePath + '/index.html'
    fs.readFile(file, 'utf8', (err, data) => {
      if (err) return reject(err)
      console.log('data:', data)
      fs.open(target + '/index.html', 'w', (err, fd) => {
        if (err) return reject(err)
        fs.write(fd, data.replace(/\{\{title\}\}/g, title), (err) => {
          if (err) return reject(err)
          fs.close(fd, err => {
            if (err) return reject(err)
            resolve(true)
          })        
        })
      })
    })
  })
}


function createConfigs(title) {
  return new Promise((resolve, reject) => {
    let now = Date.now()
    fs.open(target + '/configs.js', 'w', (err, fd) => {
      if (err) return reject(err)
      fs.write(fd, 
`export default {
  title: "${title}",
  name: "test",
  level: 7,
  time: ${now}
}
`, (err) => {
        if (err) return reject(err)
        fs.close(fd, err => {
          if (err) return reject(err)
          resolve(true)
        })
      })
    })
  })
}

async function run () {
  // let title = await inputTitle().catch(err => {
  //   console.log('input title:', err)
  //   process.exit()
  // })
  // console.log('title:', title)
  // if (!title) return
  let title = 'webgen test'
  let result = await createHtml(title).catch(err => {
    console.log('create html err:', err)
    process.exit()    
  })
  if (!result) return
  result = await createConfigs(title).catch(err => {
    console.log('create configs err:', err)
  })
  process.exit()
}

run()
